@page "/ChatHistory"
@using Microsoft.JSInterop;
@using System.Text.Json;
@using OpenAI_API.Chat;
@inject IJSRuntime JSRuntime;
@inject NavigationManager NavigationManager

<MudText Typo="Typo.h3">Chat History</MudText>

<MudDataGrid Items="@details.OrderByDescending(x => x.ChatTime)">
    <Columns>
        <PropertyColumn Property="x => x.ChatTime" Title="Time Of Chat" />
        <PropertyColumn Property="x => x.Source" Title="Convert From" />
        <PropertyColumn Property="x => x.Destination" Title="Convert To" />
        <PropertyColumn Property="x => x.MessageForGrid" Title="Message" />
            <TemplateColumn CellClass="d-flex justify-end">
                <CellTemplate>
                    <MudStack Row>
                    <MudButton Size="@Size.Small" Variant="@Variant.Filled" @onclick="() => NavigateToHome(context)" Color="@Color.Primary">View Chat</MudButton>
                    </MudStack>
                </CellTemplate>
            </TemplateColumn>
    </Columns>
</MudDataGrid>

@code {
    List<ChatDetail> details = new List<ChatDetail>();
    protected override async Task OnInitializedAsync()
    {
        var chatHistory = await JSRuntime.InvokeAsync<string[]>("GetAllChatHistory");
        if(chatHistory != null)
        {
            foreach(var chat in chatHistory)
            {
                details.Add(JsonSerializer.Deserialize<ChatDetail>(chat));
            }
        }
    }

    public void NavigateToHome(CellContext<ChatDetail> chatDetail)
    {
        NavigationManager.NavigateTo("/" + chatDetail.Item.Id);
    }
}
